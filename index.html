<script type="module">
    // 导入 Firebase 模块，包括 Google 登录及 Firestore 写入所需方法
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
    import { 
        getFirestore, doc, getDoc, setDoc, updateDoc, query, where, getDocs, collection, addDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB-sxwqPjcQp2kR3fubkhw7xg8m2FztgcA",
        authDomain: "wallet-demo-74c8b.firebaseapp.com",
        projectId: "wallet-demo-74c8b",
        storageBucket: "wallet-demo-74c8b.firebasestorage.app",
        messagingSenderId: "727957421920",
        appId: "1:727957421920:web:b5bff9853e2e8510db2805"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.addEventListener("DOMContentLoaded", () => {
        // 邮箱/密码登录事件
        document.getElementById("loginButton").addEventListener("click", function() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    window.location.href = `dashboard.html?email=${encodeURIComponent(user.email)}`;
                })
                .catch((error) => {
                    document.getElementById("message").textContent = `❌ 登录失败: ${error.message}`;
                    document.getElementById("message").style.color = "red";
                });
        });

        // 跳转到重置密码页面
        document.getElementById("resetPassword").addEventListener("click", function() {
            window.location.href = "reset.html";
        });

        // 动态创建 Google 登录按钮
        const container = document.querySelector('.container');
        const googleButton = document.createElement('button');
        googleButton.id = 'googleLogin';
        googleButton.textContent = '使用 Google 登录';
        container.appendChild(googleButton);

        // Google 登录事件，登录后检查 Firestore 中是否存在该用户记录
        googleButton.addEventListener("click", async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    // 如果记录存在，则直接跳转到 dashboard 页面
                    window.location.href = `dashboard.html?email=${encodeURIComponent(user.email)}`;
                } else {
                    // 如果记录不存在，则弹出注册表单，让用户填写 Email 和 姓名，并将 Funds 初始化为 0
                    showRegistrationModal(user);
                }
            } catch (error) {
                document.getElementById("message").textContent = `❌ Google 登录失败: ${error.message}`;
                document.getElementById("message").style.color = "red";
            }
        });
    });

    // 弹出注册表单的函数：要求用户填写 Email 和 姓名，然后将用户记录写入 Firestore，Funds 设为 0
    async function showRegistrationModal(user) {
        // 创建全屏模态遮罩
        const modal = document.createElement("div");
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
        modal.style.display = "flex";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";
        modal.style.zIndex = "1000";
        
        // 创建模态内容区域
        const modalContent = document.createElement("div");
        modalContent.style.backgroundColor = "white";
        modalContent.style.padding = "20px";
        modalContent.style.borderRadius = "10px";
        modalContent.style.textAlign = "center";
        modalContent.style.maxWidth = "400px";
        modalContent.style.width = "80%";
        
        const title = document.createElement("h2");
        title.innerText = "请完善注册信息";
        modalContent.appendChild(title);
        
        // Email 输入框（预填用户的 Google 邮箱）
        const emailLabel = document.createElement("label");
        emailLabel.innerText = "邮箱:";
        modalContent.appendChild(emailLabel);
        
        const emailInput = document.createElement("input");
        emailInput.type = "email";
        emailInput.value = user.email;
        emailInput.required = true;
        emailInput.style.width = "100%";
        emailInput.style.marginBottom = "10px";
        modalContent.appendChild(emailInput);
        
        // 姓名输入框
        const nameLabel = document.createElement("label");
        nameLabel.innerText = "姓名:";
        modalContent.appendChild(nameLabel);
        
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "请输入姓名";
        nameInput.required = true;
        nameInput.style.width = "100%";
        nameInput.style.marginBottom = "10px";
        modalContent.appendChild(nameInput);
        
        // 提交按钮
        const submitButton = document.createElement("button");
        submitButton.innerText = "注册";
        submitButton.style.padding = "10px 20px";
        submitButton.style.marginTop = "10px";
        modalContent.appendChild(submitButton);
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // 绑定提交按钮事件
        submitButton.addEventListener("click", async () => {
            const emailVal = emailInput.value.trim();
            const nameVal = nameInput.value.trim();
            if (!emailVal || !nameVal) {
                alert("请填写所有字段！");
                return;
            }
            try {
                // 将用户数据写入 Firestore，Funds 初始为 0
                await setDoc(doc(db, "users", user.uid), {
                    Email: emailVal,
                    name: nameVal,
                    Funds: 0
                });
                // 删除模态窗口并跳转到 dashboard
                document.body.removeChild(modal);
                window.location.href = `dashboard.html?email=${encodeURIComponent(emailVal)}`;
            } catch (error) {
                alert("注册失败：" + error.message);
            }
        });
    }
</script>

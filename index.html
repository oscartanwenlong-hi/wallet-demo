<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB-sxwqPjcQp2kR3fubkhw7xg8m2FztgcA",
        authDomain: "wallet-demo-74c8b.firebaseapp.com",
        projectId: "wallet-demo-74c8b",
        storageBucket: "wallet-demo-74c8b.firebasestorage.app",
        messagingSenderId: "727957421920",
        appId: "1:727957421920:web:b5bff9853e2e8510db2805"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 获取设备唯一标识符
    function generateDeviceID() {
        return localStorage.getItem("deviceID") || generateUUID();
    }

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("loginButton").addEventListener("click", function() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            signInWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    const user = userCredential.user;
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);

                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        const deviceID = generateDeviceID();

                        // 如果设备ID不同，强制登出旧设备
                        if (userData.deviceID && userData.deviceID !== deviceID) {
                            await forceLogoutOldDevice(userData.deviceID);
                        }

                        // 更新为新设备的deviceID
                        await updateDoc(userRef, {
                            deviceID: deviceID
                        });

                        // 跳转到仪表盘页面
                        window.location.href = `dashboard.html?email=${encodeURIComponent(user.email)}`;
                    } else {
                        document.getElementById("message").textContent = "❌ 用户不存在";
                        document.getElementById("message").style.color = "red";
                    }
                })
                .catch((error) => {
                    document.getElementById("message").textContent = `❌ 登录失败: ${error.message}`;
                    document.getElementById("message").style.color = "red";
                });
        });

        // 跳转到重置密码页面
        document.getElementById("resetPassword").addEventListener("click", function() {
            window.location.href = "reset.html";
        });
    });

    // 强制登出旧设备
    async function forceLogoutOldDevice(oldDeviceID) {
        console.log(`旧设备ID ${oldDeviceID} 将被登出。`);

        const user = auth.currentUser;
        if (user) {
            const userRef = doc(db, "users", user.uid);
            await updateDoc(userRef, {
                deviceID: null  // 清除设备ID，旧设备会被强制退出
            });
        }

        await auth.signOut();  // 退出当前设备
        alert("您已在其他设备登录，请退出旧设备后继续。");
        window.location.href = "index.html";  // 跳转到登录页面
    }
</script>

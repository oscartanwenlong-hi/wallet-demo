// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAuth, signInWithEmailAndPassword, signOut } from "firebase/auth";
import { getFirestore, doc, getDoc, updateDoc } from "firebase/firestore";

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyB-sxwqPjcQp2kR3fubkhw7xg8m2FztgcA",
  authDomain: "wallet-demo-74c8b.firebaseapp.com",
  projectId: "wallet-demo-74c8b",
  storageBucket: "wallet-demo-74c8b.firebasestorage.app",
  messagingSenderId: "727957421920",
  appId: "1:727957421920:web:b5bff9853e2e8510db2805"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

// 获取设备唯一标识符
function generateDeviceID() {
  return localStorage.getItem("deviceID") || generateUUID();
}

function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0,
      v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// 登录表单提交
document.getElementById("loginForm").addEventListener("submit", async (event) => {
  event.preventDefault();

  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try {
    await login(email, password);
  } catch (error) {
    document.getElementById("errorMessage").textContent = error.message;
  }
});

// 用户登录逻辑
async function login(email, password) {
  const deviceID = generateDeviceID();

  try {
    // 用户登录
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      throw new Error("用户不存在");
    }

    const userData = userSnap.data();

    // 如果设备ID不同，强制登出旧设备
    if (userData.deviceID && userData.deviceID !== deviceID) {
      await forceLogoutOldDevice(userData.deviceID);
    }

    // 更新为新设备的deviceID
    await updateDoc(userRef, {
      deviceID: deviceID
    });

    alert("登录成功！");
    window.location.href = "dashboard.html";  // 跳转到主页面

  } catch (error) {
    throw new Error(error.message);
  }
}

// 强制登出旧设备
async function forceLogoutOldDevice(oldDeviceID) {
  console.log(`旧设备ID ${oldDeviceID} 将被登出。`);

  const user = auth.currentUser;
  if (user) {
    const userRef = doc(db, "users", user.uid);
    await updateDoc(userRef, {
      deviceID: null  // 清除设备ID，旧设备会被强制退出
    });
  }

  await signOut(auth);  // 退出当前设备
  alert("您已在其他设备登录，请退出旧设备后继续。");
  window.location.href = "index.html";  // 跳转到登录页面
}

// 在首次登录时生成并存储设备ID
if (!localStorage.getItem("deviceID")) {
  const deviceID = generateUUID();
  localStorage.setItem("deviceID", deviceID);
}

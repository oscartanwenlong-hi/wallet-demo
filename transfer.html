<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¬è´¦é¡µé¢</title>
    <script type="module">
        // Firebase é…ç½®
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-sxwqPjcQp2kR3fubkhw7xg8m2FztgcA",
            authDomain: "wallet-demo-74c8b.firebaseapp.com",
            projectId: "wallet-demo-74c8b",
            storageBucket: "wallet-demo-74c8b.firebasestorage.app",
            messagingSenderId: "727957421920",
            appId: "1:727957421920:web:b5bff9853e2e8510db2805"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        let currentUser = null; // å­˜å‚¨å½“å‰ç”¨æˆ·ä¿¡æ¯

        // ç›‘å¬ç”¨æˆ·æ˜¯å¦ç™»å½•
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById("user-email").innerText = `å½“å‰ç”¨æˆ·: ${user.email}`;
            } else {
                window.location.href = "index.html"; // æœªç™»å½•å°±è·³å›ç™»å½•é¡µé¢
            }
        });

        // **ğŸ’° è½¬è´¦åŠŸèƒ½**
        async function transferMoney() {
            const receiverEmail = document.getElementById("receiver-email").value;
            const amount = parseFloat(document.getElementById("amount").value);

            if (!receiverEmail || isNaN(amount) || amount <= 0) {
                alert("è¯·è¾“å…¥æ­£ç¡®çš„æ”¶æ¬¾äººé‚®ç®±å’Œé‡‘é¢ï¼");
                return;
            }

            try {
                // è·å–å½“å‰ç”¨æˆ·çš„èµ„é‡‘ä¿¡æ¯
                const senderDocRef = doc(db, "users", currentUser.uid);
                const senderDoc = await getDoc(senderDocRef);

                if (!senderDoc.exists()) {
                    alert("å‘é€è€…ä¿¡æ¯æœªæ‰¾åˆ°ï¼");
                    return;
                }

                let senderFunds = senderDoc.data().Funds;

                if (senderFunds < amount) {
                    alert("ä½™é¢ä¸è¶³ï¼");
                    return;
                }

                // æŸ¥æ‰¾æ”¶æ¬¾äºº
                const usersRef = doc(db, "users", currentUser.uid);
                const usersSnapshot = await getDoc(usersRef);
                let receiverUid = null;

                if (usersSnapshot.exists()) {
                    receiverUid = Object.keys(usersSnapshot.data()).find(uid => usersSnapshot.data()[uid].Email === receiverEmail);
                }

                if (!receiverUid) {
                    alert("æ”¶æ¬¾äººæœªæ‰¾åˆ°ï¼");
                    return;
                }

                const receiverDocRef = doc(db, "users", receiverUid);
                const receiverDoc = await getDoc(receiverDocRef);

                if (!receiverDoc.exists()) {
                    alert("æ”¶æ¬¾äººä¿¡æ¯æœªæ‰¾åˆ°ï¼");
                    return;
                }

                let receiverFunds = receiverDoc.data().Funds;

                // æ›´æ–° Firestore ä½™é¢
                await updateDoc(senderDocRef, { Funds: senderFunds - amount });
                await updateDoc(receiverDocRef, { Funds: receiverFunds + amount });

                alert("è½¬è´¦æˆåŠŸï¼");
                window.location.href = "dashboard.html";
            } catch (error) {
                console.error("è½¬è´¦å¤±è´¥:", error);
                alert("è½¬è´¦å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
            }
        }

        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        window.onload = () => {
            document.getElementById("transfer-btn").addEventListener("click", transferMoney);
        };

    </script>
</head>
<body>
    <h1>è½¬è´¦</h1>
    <p id="user-email">å½“å‰ç”¨æˆ·: åŠ è½½ä¸­...</p>

    <label for="receiver-email">æ”¶æ¬¾äººé‚®ç®±:</label>
    <input type="email" id="receiver-email" required>

    <label for="amount">é‡‘é¢:</label>
    <input type="number" id="amount" required>

    <button id="transfer-btn">ç¡®è®¤è½¬è´¦</button>
    <br><br>
    <a href="dashboard.html">è¿”å›</a>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转账页面</title>
    <script type="module">
        // Firebase 配置
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-sxwqPjcQp2kR3fubkhw7xg8m2FztgcA",
            authDomain: "wallet-demo-74c8b.firebaseapp.com",
            projectId: "wallet-demo-74c8b",
            storageBucket: "wallet-demo-74c8b.firebasestorage.app",
            messagingSenderId: "727957421920",
            appId: "1:727957421920:web:b5bff9853e2e8510db2805"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        let currentUser = null; // 存储当前用户信息

        // 监听用户是否登录
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById("user-email").innerText = `当前用户: ${user.email}`;
            } else {
                window.location.href = "index.html"; // 未登录就跳回登录页面
            }
        });

        // **💰 转账功能**
        async function transferMoney() {
            const receiverEmail = document.getElementById("receiver-email").value;
            const amount = parseFloat(document.getElementById("amount").value);

            if (!receiverEmail || isNaN(amount) || amount <= 0) {
                alert("请输入正确的收款人邮箱和金额！");
                return;
            }

            try {
                // 获取当前用户的资金信息
                const senderDocRef = doc(db, "users", currentUser.uid);
                const senderDoc = await getDoc(senderDocRef);

                if (!senderDoc.exists()) {
                    alert("发送者信息未找到！");
                    return;
                }

                let senderFunds = senderDoc.data().Funds;

                if (senderFunds < amount) {
                    alert("余额不足！");
                    return;
                }

                // 查找收款人
                const usersRef = doc(db, "users", currentUser.uid);
                const usersSnapshot = await getDoc(usersRef);
                let receiverUid = null;

                if (usersSnapshot.exists()) {
                    receiverUid = Object.keys(usersSnapshot.data()).find(uid => usersSnapshot.data()[uid].Email === receiverEmail);
                }

                if (!receiverUid) {
                    alert("收款人未找到！");
                    return;
                }

                const receiverDocRef = doc(db, "users", receiverUid);
                const receiverDoc = await getDoc(receiverDocRef);

                if (!receiverDoc.exists()) {
                    alert("收款人信息未找到！");
                    return;
                }

                let receiverFunds = receiverDoc.data().Funds;

                // 更新 Firestore 余额
                await updateDoc(senderDocRef, { Funds: senderFunds - amount });
                await updateDoc(receiverDocRef, { Funds: receiverFunds + amount });

                alert("转账成功！");
                window.location.href = "dashboard.html";
            } catch (error) {
                console.error("转账失败:", error);
                alert("转账失败，请重试！");
            }
        }

        // 绑定按钮点击事件
        window.onload = () => {
            document.getElementById("transfer-btn").addEventListener("click", transferMoney);
        };

    </script>
</head>
<body>
    <h1>转账</h1>
    <p id="user-email">当前用户: 加载中...</p>

    <label for="receiver-email">收款人邮箱:</label>
    <input type="email" id="receiver-email" required>

    <label for="amount">金额:</label>
    <input type="number" id="amount" required>

    <button id="transfer-btn">确认转账</button>
    <br><br>
    <a href="dashboard.html">返回</a>
</body>
</html>
